<?php
/**
 * Script d'Installation Automatique des Pages Video Library Protect
 * 
 * Ce script cr√©e automatiquement toutes les pages n√©cessaires 
 * pour le syst√®me Video Library Protect dans WordPress.
 * 
 * UTILISATION :
 * 1. Placez ce fichier dans votre installation WordPress
 * 2. Acc√©dez √† l'URL : votre-site.com/install-pages-wordpress.php
 * 3. Les pages seront cr√©√©es automatiquement
 * 4. Supprimez ce fichier apr√®s utilisation
 */

// S√©curit√© : V√©rifier que nous sommes dans WordPress
if (!defined('ABSPATH')) {
    // Essayer de charger WordPress
    $wp_config_paths = [
        __DIR__ . '/wp-config.php',
        __DIR__ . '/../wp-config.php', 
        __DIR__ . '/../../wp-config.php',
        __DIR__ . '/../../../wp-config.php'
    ];
    
    $wp_loaded = false;
    foreach ($wp_config_paths as $config_path) {
        if (file_exists($config_path)) {
            require_once $config_path;
            require_once ABSPATH . 'wp-admin/includes/post.php';
            $wp_loaded = true;
            break;
        }
    }
    
    if (!$wp_loaded) {
        die('‚ùå Erreur : Impossible de charger WordPress. Placez ce fichier dans le r√©pertoire WordPress.');
    }
}

/**
 * Classe pour installer les pages Video Library Protect
 */
class VLP_Pages_Installer {
    
    private $pages_created = [];
    private $errors = [];
    
    /**
     * Installer toutes les pages
     */
    public function install_all_pages() {
        echo "<h1>üé¨ Installation des Pages Video Library Protect</h1>";
        echo "<div style='max-width: 800px; margin: 20px auto; font-family: Arial, sans-serif;'>";
        
        // V√©rifier les pr√©requis
        $this->check_prerequisites();
        
        // Cr√©er les pages
        $pages = $this->get_pages_data();
        
        foreach ($pages as $page_data) {
            $this->create_page($page_data);
        }
        
        // Afficher le r√©sum√©
        $this->display_summary();
        
        echo "</div>";
    }
    
    /**
     * V√©rifier les pr√©requis
     */
    private function check_prerequisites() {
        echo "<h2>üîç V√©rification des pr√©requis...</h2>";
        
        // V√©rifier les permissions
        if (!current_user_can('edit_pages')) {
            $this->errors[] = "Permissions insuffisantes pour cr√©er des pages";
        }
        
        // V√©rifier si le plugin VLP est actif
        if (!class_exists('Video_Library_Protect')) {
            echo "<div style='background: #fff3cd; padding: 15px; border-left: 4px solid #ffc107; margin: 10px 0;'>";
            echo "‚ö†Ô∏è <strong>Attention :</strong> Le plugin Video Library Protect ne semble pas √™tre activ√©.";
            echo "</div>";
        } else {
            echo "<div style='background: #d4edda; padding: 15px; border-left: 4px solid #28a745; margin: 10px 0;'>";
            echo "‚úÖ Plugin Video Library Protect d√©tect√©";
            echo "</div>";
        }
        
        // V√©rifier GiftCode Protect
        if (class_exists('GiftCode_Manager')) {
            echo "<div style='background: #d4edda; padding: 15px; border-left: 4px solid #28a745; margin: 10px 0;'>";
            echo "‚úÖ Plugin GiftCode Protect v2 d√©tect√©";
            echo "</div>";
        } else {
            echo "<div style='background: #f8d7da; padding: 15px; border-left: 4px solid #dc3545; margin: 10px 0;'>";
            echo "‚ùå Plugin GiftCode Protect v2 non trouv√© (optionnel mais recommand√©)";
            echo "</div>";
        }
        
        if (!empty($this->errors)) {
            echo "<div style='background: #f8d7da; padding: 15px; border-left: 4px solid #dc3545; margin: 10px 0;'>";
            echo "<strong>‚ùå Erreurs d√©tect√©es :</strong><ul>";
            foreach ($this->errors as $error) {
                echo "<li>{$error}</li>";
            }
            echo "</ul></div>";
            return false;
        }
        
        return true;
    }
    
    /**
     * Obtenir les donn√©es des pages √† cr√©er
     */
    private function get_pages_data() {
        return [
            [
                'title' => 'Biblioth√®que Vid√©o',
                'slug' => 'video-library',
                'content' => $this->get_video_library_content(),
                'description' => 'Page principale pour d√©couvrir et regarder toutes nos vid√©os'
            ],
            [
                'title' => 'Cat√©gories de Vid√©os', 
                'slug' => 'categories-videos',
                'content' => $this->get_categories_content(),
                'description' => 'Naviguez dans nos vid√©os par cat√©gories th√©matiques'
            ],
            [
                'title' => 'Contenu Prot√©g√© - Exemple',
                'slug' => 'contenu-protege-exemple', 
                'content' => $this->get_protected_content(),
                'description' => 'Exemple de page avec du contenu prot√©g√© par codes cadeaux'
            ],
            [
                'title' => 'Aide & Support Vid√©o',
                'slug' => 'aide-support-video',
                'content' => $this->get_help_content(), 
                'description' => 'Guide complet pour utiliser la biblioth√®que vid√©o et les codes cadeaux'
            ]
        ];
    }
    
    /**
     * Cr√©er une page WordPress
     */
    private function create_page($page_data) {
        echo "<h3>üìÑ Cr√©ation de la page : {$page_data['title']}</h3>";
        
        // V√©rifier si la page existe d√©j√†
        $existing_page = get_page_by_path($page_data['slug']);
        
        if ($existing_page) {
            echo "<div style='background: #fff3cd; padding: 10px; margin: 5px 0;'>";
            echo "‚ö†Ô∏è La page existe d√©j√†. <a href='" . get_edit_post_link($existing_page->ID) . "'>Modifier</a> | ";
            echo "<a href='" . get_permalink($existing_page->ID) . "'>Voir</a>";
            echo "</div>";
            return;
        }
        
        // Cr√©er la page
        $page_id = wp_insert_post([
            'post_title' => $page_data['title'],
            'post_name' => $page_data['slug'],
            'post_content' => $page_data['content'],
            'post_status' => 'publish',
            'post_type' => 'page',
            'post_author' => get_current_user_id(),
            'meta_input' => [
                '_vlp_page_description' => $page_data['description']
            ]
        ]);
        
        if (is_wp_error($page_id)) {
            echo "<div style='background: #f8d7da; padding: 10px; margin: 5px 0;'>";
            echo "‚ùå Erreur lors de la cr√©ation : " . $page_id->get_error_message();
            echo "</div>";
            $this->errors[] = "Impossible de cr√©er la page : {$page_data['title']}";
        } else {
            echo "<div style='background: #d4edda; padding: 10px; margin: 5px 0;'>";
            echo "‚úÖ Page cr√©√©e avec succ√®s ! ";
            echo "<a href='" . get_edit_post_link($page_id) . "'>Modifier</a> | ";
            echo "<a href='" . get_permalink($page_id) . "'>Voir</a>";
            echo "</div>";
            
            $this->pages_created[] = [
                'title' => $page_data['title'],
                'url' => get_permalink($page_id),
                'edit_url' => get_edit_post_link($page_id)
            ];
        }
    }
    
    /**
     * Afficher le r√©sum√© de l'installation
     */
    private function display_summary() {
        echo "<h2>üìä R√©sum√© de l'Installation</h2>";
        
        if (!empty($this->pages_created)) {
            echo "<div style='background: #d4edda; padding: 20px; border-left: 4px solid #28a745; margin: 20px 0;'>";
            echo "<h3>‚úÖ Pages cr√©√©es avec succ√®s (" . count($this->pages_created) . ") :</h3>";
            echo "<ul>";
            foreach ($this->pages_created as $page) {
                echo "<li><strong>{$page['title']}</strong> - ";
                echo "<a href='{$page['url']}' target='_blank'>Voir</a> | ";
                echo "<a href='{$page['edit_url']}' target='_blank'>Modifier</a>";
                echo "</li>";
            }
            echo "</ul>";
            echo "</div>";
        }
        
        if (!empty($this->errors)) {
            echo "<div style='background: #f8d7da; padding: 20px; border-left: 4px solid #dc3545; margin: 20px 0;'>";
            echo "<h3>‚ùå Erreurs rencontr√©es :</h3>";
            echo "<ul>";
            foreach ($this->errors as $error) {
                echo "<li>{$error}</li>";
            }
            echo "</ul>";
            echo "</div>";
        }
        
        echo "<div style='background: #e8f4fd; padding: 20px; border-left: 4px solid #3498db; margin: 20px 0;'>";
        echo "<h3>üöÄ Prochaines √©tapes :</h3>";
        echo "<ol>";
        echo "<li>V√©rifiez que toutes les pages s'affichent correctement</li>";
        echo "<li>Configurez votre menu de navigation pour inclure ces pages</li>";
        echo "<li>Testez les shortcodes avec des vid√©os de d√©monstration</li>";
        echo "<li>Personnalisez le CSS selon votre design</li>";
        echo "<li><strong>Supprimez ce fichier install-pages-wordpress.php</strong></li>";
        echo "</ol>";
        echo "</div>";
        
        echo "<div style='background: #fff3cd; padding: 15px; border-left: 4px solid #ffc107; margin: 20px 0;'>";
        echo "üîí <strong>S√©curit√© :</strong> N'oubliez pas de supprimer ce fichier apr√®s l'installation !";
        echo "</div>";
    }
    
    /**
     * Contenu de la page Biblioth√®que Vid√©o
     */
    private function get_video_library_content() {
        return '
<div class="vlp-info-box" style="background: #e8f4fd; border-left: 4px solid #3498db; padding: 20px; margin: 20px 0;">
    <h3>üé• Votre Biblioth√®que Vid√©o</h3>
    <p>Cette page affiche toutes vos vid√©os disponibles. Les vid√©os peuvent √™tre gratuites ou prot√©g√©es par des codes cadeaux.</p>
</div>

[vlp_video_library]

<div class="vlp-features" style="background: #f8f9fa; padding: 30px; border-radius: 8px; margin: 30px 0;">
    <h4>üí° Fonctionnalit√©s disponibles :</h4>
    <ul>
        <li>üîç <strong>Recherche</strong> : Trouvez rapidement une vid√©o</li>
        <li>üìÅ <strong>Filtres par cat√©gorie</strong> : Naviguez par th√®me</li>
        <li>üîí <strong>Protection par codes</strong> : Acc√®s s√©curis√© aux contenus premium</li>
        <li>üëÅÔ∏è <strong>Aper√ßus gratuits</strong> : D√©couvrez le contenu avant l\'achat</li>
        <li>üì± <strong>Design responsive</strong> : Fonctionne sur tous les appareils</li>
    </ul>
</div>

<div class="vlp-tip" style="background: #d4edda; border-left: 4px solid #28a745; padding: 20px; margin: 20px 0;">
    <p><strong>üéØ Astuce :</strong> Si vous avez des codes cadeaux, saisissez-les directement sur les vid√©os prot√©g√©es pour d√©bloquer l\'acc√®s complet !</p>
</div>';
    }
    
    /**
     * Contenu de la page Cat√©gories
     */
    private function get_categories_content() {
        return '
<div class="vlp-info-box" style="background: #e8f4fd; border-left: 4px solid #3498db; padding: 20px; margin: 20px 0;">
    <h3>üìÅ Explorez nos Cat√©gories</h3>
    <p>D√©couvrez nos vid√©os organis√©es par th√®mes et sujets. Chaque cat√©gorie peut avoir son propre niveau de protection.</p>
</div>

[vlp_video_categories layout="grid" columns="3" show_count="true" show_protected="true"]

<div class="vlp-guide" style="background: #f8f9fa; padding: 30px; border-radius: 8px; margin: 30px 0;">
    <h4>üöÄ Comment naviguer dans les cat√©gories :</h4>
    <ol>
        <li><strong>Parcourez les cat√©gories</strong><br>Chaque cat√©gorie affiche le nombre de vid√©os et son statut de protection</li>
        <li><strong>Identifiez les protections</strong><br>L\'ic√¥ne üîí indique qu\'un code cadeau est requis pour acc√©der au contenu</li>
        <li><strong>Cliquez pour explorer</strong><br>Acc√©dez directement aux vid√©os de la cat√©gorie qui vous int√©resse</li>
        <li><strong>Utilisez vos codes</strong><br>Saisissez votre code cadeau pour d√©bloquer une cat√©gorie enti√®re</li>
    </ol>
</div>';
    }
    
    /**
     * Contenu de la page Prot√©g√©e
     */
    private function get_protected_content() {
        return '
<div class="vlp-info-box" style="background: #e8f4fd; border-left: 4px solid #3498db; padding: 20px; margin: 20px 0;">
    <h3>üîí Contenu Exclusif</h3>
    <p>Cette page d√©montre comment prot√©ger du contenu sp√©cifique avec des codes cadeaux personnalis√©s.</p>
</div>

[vlp_protected_content codes="VIP-ACCESS,PREMIUM-2024" message="Ce contenu exclusif n√©cessite un code VIP ou Premium." unlock_message="üéâ Bienvenue dans notre espace VIP !"]

<h3>üåü Contenu Exclusif VIP</h3>
<p>F√©licitations ! Vous avez d√©bloqu√© notre contenu exclusif.</p>

<div style="background: #d4edda; border-left: 4px solid #28a745; padding: 20px; margin: 20px 0;">
    <h4>üéÅ Avantages VIP inclus :</h4>
    <ul>
        <li>‚ú® Acc√®s anticip√© aux nouvelles vid√©os</li>
        <li>üé• Contenu bonus et coulisses</li>
        <li>üí¨ Communaut√© priv√©e VIP</li>
        <li>üìß Newsletter exclusive avec conseils priv√©s</li>
        <li>üéØ Formations avanc√©es r√©serv√©es aux membres</li>
    </ul>
</div>

[/vlp_protected_content]';
    }
    
    /**
     * Contenu de la page d'aide
     */
    private function get_help_content() {
        return '
<div class="vlp-info-box" style="background: #e8f4fd; border-left: 4px solid #3498db; padding: 20px; margin: 20px 0;">
    <h3>‚ùì Centre d\'Aide - Video Library Protect</h3>
    <p>Trouvez rapidement les r√©ponses √† vos questions sur l\'utilisation de notre biblioth√®que vid√©o et des codes cadeaux.</p>
</div>

<h3>üöÄ Guide de d√©marrage rapide</h3>
<div style="background: #f8f9fa; padding: 30px; border-radius: 8px; margin: 30px 0;">
    <ol>
        <li><strong>D√©couvrez la biblioth√®que</strong><br>Rendez-vous sur la page de la biblioth√®que vid√©o pour voir toutes les vid√©os disponibles</li>
        <li><strong>Explorez les cat√©gories</strong><br>Naviguez par th√®me sur la page des cat√©gories</li>
        <li><strong>Regardez les aper√ßus gratuits</strong><br>Toutes les vid√©os ont un aper√ßu gratuit pour vous aider √† choisir</li>
        <li><strong>Utilisez vos codes cadeaux</strong><br>Saisissez votre code pour d√©bloquer la vid√©o compl√®te ou une cat√©gorie enti√®re</li>
    </ol>
</div>

<h3>üîë Utilisation des Codes Cadeaux</h3>
<div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 20px; margin: 20px 0;">
    <h4>Format des codes :</h4>
    <ul>
        <li>Entre 3 et 50 caract√®res</li>
        <li>Lettres, chiffres et tirets autoris√©s</li>
        <li>Pas de distinction majuscules/minuscules</li>
        <li>Exemples : <code>NOEL2024</code>, <code>promo-hiver</code>, <code>VIP-ACCESS</code></li>
    </ul>
</div>';
    }
}

// Ex√©cuter l'installation si on acc√®de directement au fichier
if (!defined('WP_CLI') && !wp_doing_ajax()) {
    // V√©rifier les permissions basiques
    if (!function_exists('wp_insert_post')) {
        die('‚ùå Erreur : Ce script doit √™tre ex√©cut√© dans un contexte WordPress valide.');
    }
    
    $installer = new VLP_Pages_Installer();
    $installer->install_all_pages();
    
    echo "<div style='text-align: center; margin: 30px 0; padding: 20px; background: #fff3cd; border-radius: 8px;'>";
    echo "<h3>üö® IMPORTANT - S√âCURIT√â</h3>";
    echo "<p><strong>N'oubliez pas de supprimer ce fichier apr√®s l'installation !</strong></p>";
    echo "<p>Pour des raisons de s√©curit√©, supprimez <code>install-pages-wordpress.php</code> de votre serveur.</p>";
    echo "</div>";
}
?>